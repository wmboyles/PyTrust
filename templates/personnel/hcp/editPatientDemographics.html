<!DOCTYPE html>
<html>
    <head>
        <title>HCP | Edit Patient Demographics</title>
        <!-- Bootstrap import -->
        <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        />
        <!-- AngularJS import -->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
        <!-- AngularJS code -->
        <script>
            var app = angular.module(
                "editPatientDemographicsApp",
                [],
                // Change the delimiter symbols to [[ and ]]
                ($interpolateProvider) => {
                    $interpolateProvider.startSymbol("[[");
                    $interpolateProvider.endSymbol("]]");
                }
            );
            app.factory("waitForLoadPatients", ($http) => {
                var load_patients = () => {
                    return $http.get("/api/patients").then(
                        (res) => {
                            return res.data;
                        },
                        (err) => {
                            return [];
                        }
                    );
                };

                return { load_patients: load_patients };
            });
            app.controller(
                "editPatientDemographicsCtrl",
                ($scope, $http, waitForLoadPatients) => {
                    // load all the states
                    $scope.load_states = () => {
                        $http.get("/api/states").then(
                            (res) => {
                                $scope.states = res.data;
                            },
                            (err) => {
                                $scope.states = [];
                            }
                        );
                    };

                    // when submit button is pressed
                    $scope.submit_demographics = () => {
                        $http.put("/api/patients", $scope.patient).then(
                            (res) => {
                                $scope.error_message = "";
                                $scope.success_message =
                                    "Successfully updated patient demographics";

                                $scope.patients = [];
                                var patients_promise = waitForLoadPatients.load_patients();
                                patients_promise.then((res2) => {
                                    $scope.patients = res2;

                                    for (var i in $scope.patients) {
                                        if (
                                            $scope.patients[i].user.id ===
                                            res.data.user.id
                                        ) {
                                            $scope.patient = $scope.patients[i];
                                        }
                                    }
                                });
                            },
                            (err) => {
                                $scope.error_message = err.data;
                                $scope.success_message = "";
                            }
                        );
                    };

                    // runs on page load
                    $scope.load_states();
                    var patients_promise = waitForLoadPatients.load_patients();
                    patients_promise.then((res) => {
                        $scope.patients = res;
                    });
                }
            );
        </script>
    </head>
    <body
        ng-app="editPatientDemographicsApp"
        ng-controller="editPatientDemographicsCtrl"
    >
        <div class="container">
            <div class="row">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h1>HCP Edit Patient Demographics</h1>
                    </div>
                    <div class="panel-body">
                        <!-- Select patient panel -->
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <div class="col-md-4"></div>
                                <div class="col-md-4">
                                    <label for="selected_patient"
                                        >Patient</label
                                    >
                                    <select
                                        class="form-control"
                                        name="selected_patient"
                                        ng-model="patient"
                                        ng-options="p as (p.first_name + ' ' + p.last_name + ' (' + p.user.username + ')') for p in patients track by p.user.id"
                                    >
                                        <option value="">Select One</option>
                                    </select>
                                </div>
                                <div class="col-md-4"></div>
                            </div>
                        </div>
                        <!-- edit patient panel-->
                        <div class="panel panel-default">
                            <div class="panel-body">
                                <form
                                    class="form"
                                    role="form"
                                    name="edit_patient_demographics_form"
                                    ng-submit="submit_demographics(edit_patient_demographics_form.$valid)"
                                    ng-if="patient"
                                >
                                    <!-- first and last name -->
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="patient_first_name"
                                                >First Name</label
                                            >
                                            <input
                                                type="text"
                                                class="form-control"
                                                name="patient_first_name"
                                                ng-model="patient.first_name"
                                                minlength="1"
                                                maxlength="127"
                                                placeholder="First Name"
                                                required
                                            />
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="patient_last_name"
                                                >Last Name</label
                                            >
                                            <input
                                                type="text"
                                                class="form-control"
                                                name="patient_last_name"
                                                ng-model="patient.last_name"
                                                minlength="1"
                                                maxlength="127"
                                                placeholder="Last Name"
                                                required
                                            />
                                        </div>
                                    </div>
                                    <!-- location fields -->
                                    <div class="form-row">
                                        <div class="form-group col-md-4">
                                            <label for="patient_address"
                                                >Address</label
                                            >
                                            <input
                                                type="text"
                                                class="form-control"
                                                name="patient_address"
                                                ng-model="patient.address"
                                                minlength="1"
                                                maxlength="127"
                                                placeholder="Street Address"
                                                required
                                            />
                                        </div>
                                        <div class="form-group col-md-3">
                                            <label for="patient_city"
                                                >City</label
                                            >
                                            <input
                                                type="text"
                                                class="form-control"
                                                name="patient_city"
                                                ng-model="patient.city"
                                                minlength="1"
                                                maxlength="127"
                                                placeholder="City"
                                                required
                                            />
                                        </div>
                                        <div class="form-group col-md-3">
                                            <label for="patient_state"
                                                >State</label
                                            >
                                            <select
                                                class="form-control"
                                                name="patient_state"
                                                ng-model="patient.state"
                                                required
                                            >
                                                <option value="">
                                                    Select One
                                                </option>
                                                <!-- prettier-ignore -->
                                                <option ng-repeat="st in states" ng-value="st[0]">[[ st[0] + " - " + st[1] ]]</option>
                                            </select>
                                        </div>
                                        <div class="form-group col-md-2">
                                            <label for="patient_zip">Zip</label>
                                            <input
                                                type="text"
                                                class="form-control"
                                                name="patient_zip"
                                                ng-model="patient.zip"
                                                minlength="1"
                                                maxlength="5"
                                                placeholder="#####"
                                                pattern="[1-9][0-9]{4}"
                                                required
                                            />
                                        </div>
                                    </div>
                                    <!-- submit button -->
                                    <div class="form-row">
                                        <div class="col-md-12 text-right">
                                            <button
                                                type="submit"
                                                class="btn btn-success"
                                                name="submit"
                                            >
                                                Submit
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <!-- success and error messages -->
                        <div>
                            <!-- prettier-ignore -->
                            <p class="text-danger" ng-model="error_message">[[error_message]]</p>
                            <!-- prettier-ignore -->
                            <p class="text-success" ng-model="success_message">[[success_message]]</p>
                        </div>
                    </div>
                </div>
            </div>
            <a href="/hcp">Home</a>
        </div>
    </body>
</html>
