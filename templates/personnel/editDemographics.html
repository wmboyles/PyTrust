<!DOCTYPE html>
<html>
    <head>
        <title>Personnel | Edit Demographics</title>
        <!-- Bootstrap import -->
        <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        />
        <!-- AngularJS import -->
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
        <!-- AngularJS code -->
        <script>
            var app = angular.module(
                "editDemographicsApp",
                [],
                // Change the delimiter symbols to [[ and ]]
                ($interpolateProvider) => {
                    $interpolateProvider.startSymbol("[[");
                    $interpolateProvider.endSymbol("]]");
                }
            );
            // load full personnel personnel object if it exists
            // if not, load just the user object
            app.factory("waitForSelfToLoad", ($http) => {
                var load_self = () => {
                    return $http.get("/api/personnel/self").then(
                        (res) => {
                            return [true, res.data];
                        },
                        (err) => {
                            return [false, err.data];
                        }
                    );
                };

                return { load_self: load_self };
            });
            app.controller(
                "editDemographicsCtrl",
                ($scope, $http, waitForSelfToLoad) => {
                    var check_personnel = (personnel) => {
                        // TODO
                    };

                    // load all the hospitals
                    // $scope.personnel.user MUST exist to call this method
                    $scope.load_workplaces = () => {
                        var url = "/api/";
                        if ($scope.personnel.user.role == "hcp") {
                            url += "hospitals";
                        } else if ($scope.personnel.user.role == "pharmacist") {
                            url += "pharmacies";
                        } else {
                            $scope.error_message =
                                "No workplaces associated with user role";
                        }

                        $http.get(url).then(
                            (res) => {
                                $scope.workplaces = res.data;
                            },
                            (err) => {
                                $scope.workplaces = [];
                            }
                        );
                    };

                    // load all the states
                    $scope.load_states = () => {
                        $http.get("/api/states").then(
                            (res) => {
                                $scope.states = res.data;
                            },
                            (err) => {
                                $scope.states = [];
                            }
                        );
                    };

                    // when submit button is pressed
                    $scope.submit_demographics = () => {
                        var err = check_personnel($scope.personnel);
                        if (err) {
                            $scope.error_message = err;
                            $scope.success_message = "";
                        }

                        var fn = $http.post;
                        if ($scope.existing_personnel) {
                            var fn = $http.put;
                        }

                        fn("/api/personnel", $scope.personnel).then(
                            (res) => {
                                $scope.error_message = "";
                                $scope.success_message =
                                    "Successfully updated demographics";

                                var self_promise = waitForSelfToLoad.load_self();
                                self_promise.then((res) => {
                                    $scope.existing_personnel = res[0];
                                    if ($scope.existing_personnel) {
                                        $scope.personnel = res[1];
                                    } else {
                                        $scope.personnel = {};
                                        $scope.personnel.user = res[1];
                                    }
                                });
                            },
                            (err) => {
                                $scope.error_message = err.data;
                                $scope.success_message = "";
                            }
                        );
                    };

                    // delete personnel self
                    $scope.delete_self = () => {
                        if (!$scope.existing_personnel) {
                            $scope.error_message =
                                "You already don't have personnel demographic information";
                            $scope.success_message = "";
                            return;
                        }
                        if (
                            confirm(
                                "Are you sure you want to delete your personnel demographic information? You will still have an account."
                            )
                        ) {
                            $http
                                .delete(
                                    "/api/personnel/" + $scope.personnel.user.id
                                )
                                .then(
                                    (res) => {
                                        $scope.error_message = "";
                                        $scope.success_message =
                                            "Successfully deleted personnel demographic information";

                                        var self_promise = waitForSelfToLoad.load_self();
                                        self_promise.then((res) => {
                                            $scope.existing_personnel = res[0];
                                            if ($scope.existing_personnel) {
                                                $scope.personnel = res[1];
                                            } else {
                                                $scope.personnel = {};
                                                $scope.personnel.user = res[1];
                                            }
                                        });
                                    },
                                    (err) => {
                                        $scope.error_message =
                                            "Could not delete personnel demographic information";
                                        $scope.success_message = "";
                                    }
                                );
                        }
                    };

                    // runs on pageload
                    $scope.load_states();
                    var self_promise = waitForSelfToLoad.load_self();
                    self_promise.then((res) => {
                        $scope.existing_personnel = res[0];
                        if ($scope.existing_personnel) {
                            $scope.personnel = res[1];
                        } else {
                            $scope.personnel = {};
                            $scope.personnel.user = res[1];
                        }

                        $scope.load_workplaces();
                    });
                }
            );
        </script>
    </head>
    <body ng-app="editDemographicsApp" ng-controller="editDemographicsCtrl">
        <div class="container">
            <div class="row">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <h1>Personnel Edit Demographics</h1>
                    </div>
                    <div class="panel-body">
                        <form
                            class="form"
                            role="form"
                            name="personnel_edit_demographics_form"
                            ng-submit="submit_demographics(personnel_edit_demographics_form.$valid)"
                        >
                            <!-- name, workplace -->
                            <div class="form-row">
                                <div class="form-group col-md-3">
                                    <label for="personnel_first_name"
                                        >First Name</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        name="personnel_first_name"
                                        ng-model="personnel.first_name"
                                        minlength="1"
                                        maxlength="127"
                                        placeholder="First Name"
                                        required
                                    />
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="personnel_last_name"
                                        >Last Name</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        name="personnel_last_name"
                                        ng-model="personnel.last_name"
                                        minlength="1"
                                        maxlength="127"
                                        placeholder="Last Name"
                                        required
                                    />
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="personnel_hospital"
                                        >Workplace</label
                                    >
                                    <select
                                        class="form-control"
                                        name="personnel_hospital"
                                        ng-if="personnel.user.role == 'hcp'"
                                        ng-model="personnel.hospital"
                                        ng-options="h as (h.name + ' - ' + h.address + ' ' + h.city + ', ' + h.state + ' ' + h.zip) for h in workplaces track by h.id"
                                    >
                                        <option value="">Not Specified</option>
                                    </select>
                                    <select
                                        class="form-control"
                                        name="personnel_pharmacy"
                                        ng-if="personnel.user.role == 'pharmacist'"
                                        ng-model="personnel.pharmacy"
                                        ng-options="p as (p.name + ' - ' + p.address + ' ' + p.city + ', ' + p.state + ' ' + p.zip) for p in workplaces track by p.id"
                                    >
                                        <option value="">Not Specified</option>
                                    </select>
                                </div>
                            </div>
                            <!-- location fields -->
                            <div class="form-row">
                                <div class="form-group col-md-4">
                                    <label for="personnel_address"
                                        >Address</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        name="personnel_address"
                                        ng-model="personnel.address"
                                        minlength="1"
                                        maxlength="127"
                                        placeholder="Street Address"
                                        required
                                    />
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="personnel_city">City</label>
                                    <input
                                        type="text"
                                        class="form-control"
                                        name="personnel_city"
                                        ng-model="personnel.city"
                                        minlength="1"
                                        maxlength="127"
                                        placeholder="City"
                                        required
                                    />
                                </div>
                                <div class="form-group col-md-3">
                                    <label for="personnel_state">State</label>
                                    <select
                                        class="form-control"
                                        name="personnel_state"
                                        ng-model="personnel.state"
                                        required
                                    >
                                        <option value="">Select One</option>
                                        <!-- prettier-ignore -->
                                        <option ng-repeat="st in states" ng-value="st[0]">[[ st[0] + " - " + st[1] ]]</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-2">
                                    <label for="personnel_zip">Zip</label>
                                    <input
                                        type="text"
                                        class="form-control"
                                        name="personnel_zip"
                                        ng-model="personnel.zip"
                                        minlength="1"
                                        maxlength="5"
                                        placeholder="#####"
                                        pattern="[0-9]{5}"
                                        required
                                    />
                                </div>
                            </div>
                            <!-- submit and delete button -->
                            <div class="form-row">
                                <div class="col-md-6 text-left">
                                    <button
                                        type="button"
                                        class="btn btn-danger"
                                        name="delete"
                                        ng-click="delete_self()"
                                    >
                                        Delete
                                    </button>
                                </div>
                                <div class="col-md-6 text-right">
                                    <button
                                        type="submit"
                                        class="btn btn-success"
                                        name="submit"
                                    >
                                        Submit
                                    </button>
                                </div>
                            </div>
                        </form>
                        <!-- success and error messages -->
                        <div>
                            <!-- prettier-ignore -->
                            <p class="text-danger" ng-model="error_message">[[error_message]]</p>
                            <!-- prettier-ignore -->
                            <p class="text-success" ng-model="success_message">[[success_message]]</p>
                        </div>
                    </div>
                </div>
            </div>
            <a href="/">Home</a>
        </div>
    </body>
</html>
